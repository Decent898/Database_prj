{% extends 'base.html' %}
{% load blog_extras %}

{% block title %}互动签名墙 - {{ board.title|default:"无标题" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/subpages.css">
<style>
    #signature-board {
        position: relative;
        width: 100%;
        height: 600px;
        background: linear-gradient(45deg, #6c5ce7 25%, #a29bfe 25%, #a29bfe 50%, #6c5ce7 50%, #6c5ce7 75%, #a29bfe 75%);
        background-size: 50px 50px;
        border: 10px solid #5649c0;
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        transition: all 0.5s ease;
    }
    
    .signature-item {
        position: absolute;
        cursor: grab;  /* 默认为抓取手势 */
        user-select: none;
        max-width: 200px;
        background-color: white;
        padding: 10px;
        padding-bottom: 25px; /* 为底部文字留出空间 */
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        transition: box-shadow 0.2s ease, transform 0.05s ease-out;
        border-radius: 8px;
        margin: 10px; /* 添加外边距防止卡片紧贴 */
    }
    
    .signature-item:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .signature-item.dragging {
        cursor: grabbing;  /* 拖拽时为抓取中手势 */
        opacity: 0.95;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        z-index: 1000 !important;
    }
    
    .signature-item img {
        max-width: 100%;
        border-radius: 6px;
        margin-bottom: 8px;
    }
    
    .signature-item.rotating {
        transition: transform 0.05s ease;
    }
    
    @keyframes saveSuccess {
        0% { box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.5); }
        50% { box-shadow: 0 0 10px 5px rgba(40, 167, 69, 0.5); }
        100% { box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); }
    }
    
    .signature-item.save-success {
        animation: saveSuccess 1s ease-out;
    }
    
    .signature-item.resetting {
        transform: scale(0.8) !important;
        opacity: 0.5 !important;
        filter: blur(3px);
    }
    
    .signature-item.resizing {
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.5) !important;
    }
    
    .signature-item.temp-draggable {
        cursor: move !important;
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.6) !important;
        z-index: 1000 !important;
    }
    
    .signature-item .resize-handle:hover,
    .signature-item .rotate-handle:hover,
    .signature-item .move-handle:hover {
        transform: scale(1.2);
        opacity: 1;
    }
    
    .control-btn {
        position: absolute;
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        color: #333;
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        opacity: 0;
        z-index: 100;
    }
    
    .signature-item:hover .control-btn {
        opacity: 0.8;
    }
    
    .control-btn:hover {
        opacity: 1 !important;
        transform: scale(1.1);
        box-shadow: 0 3px 7px rgba(0,0,0,0.3);
    }
    
    /* 缩放按钮 - 左下角 */
    .resize-handle {
        bottom: -15px;
        left: -15px;
        background-color: #28a745;
        cursor: nwse-resize;
        z-index: 110; /* 确保按钮在顶层 */
    }
    
    .resize-handle i {
        color: white;
        transform: rotate(-45deg);
    }
    
    /* 旋转按钮 - 右下角 */
    .rotate-handle {
        bottom: -15px;
        right: -15px;
        background-color: #007bff;
        cursor: grab;
        z-index: 110; /* 确保按钮在顶层 */
    }
    
    .rotate-handle:active {
        cursor: grabbing;
    }
    
    .rotate-handle i {
        color: white;
    }
    
    /* 移动按钮 - 右上角 */
    .move-handle {
        top: -15px;
        right: -15px;
        background-color: #ffc107;
        cursor: move;
        z-index: 110; /* 确保按钮在顶层 */
    }
    
    .move-handle i {
        color: #333;
    }
    
    #board-controls {
        margin-bottom: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        margin-top: 10px;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    /* 右键菜单样式 */
    .context-menu {
        position: absolute;
        z-index: 10000;
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        padding: 5px 0;
        min-width: 150px;
        display: none;
    }
    
    .context-menu.show {
        display: block;
    }
    
    .context-menu-item {
        padding: 8px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
    }
    
    .context-menu-item:hover {
        background-color: #f5f5f5;
    }
    
    .context-menu-item i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    .context-menu-separator {
        height: 1px;
        background-color: #e0e0e0;
        margin: 5px 0;
    }
    
    .context-menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .context-menu-item.disabled:hover {
        background-color: inherit;
    }
    
    /* 被隐藏的签名项 */
    .signature-item.hidden {
        display: none;
    }
    
    /* 侧边签名菜单样式 */
    #signatures-sidebar {
        position: absolute;
        right: 0;
        top: 0;
        width: 250px;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        border-left: 1px solid #ddd;
        padding: 10px;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        z-index: 100;
        transition: transform 0.3s ease-in-out;
    }
    
    .sidebar-closed {
        transform: translateX(250px);
    }
    
    #sidebar-toggle {
        position: absolute;
        top: 50%;
        left: -30px;
        width: 30px;
        height: 80px;
        background: #fff;
        border: 1px solid #ddd;
        border-right: none;
        border-radius: 6px 0 0 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: -3px 0 8px rgba(0,0,0,0.15);
        transform: translateY(-50%);
        transition: all 0.2s ease;
        z-index: 101;
    }
    
    #sidebar-toggle:hover {
        background-color: #f0f0f0;
        left: -32px;
        box-shadow: -4px 0 10px rgba(0,0,0,0.2);
    }
    
    #sidebar-toggle i {
        color: #007bff;
        font-size: 16px;
    }
    
    .my-signature-item {
        position: relative;
        margin-bottom: 10px;
        padding: 5px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: grab;
        transition: all 0.2s ease;
    }
    
    .my-signature-item:hover {
        background: #f0f0f0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .my-signature-item img {
        max-width: 100%;
        height: auto;
        border-radius: 3px;
    }
    
    .my-signature-title {
        font-size: 12px;
        margin-top: 5px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
    }
    
    .sidebar-header h5 {
        margin: 0;
        font-size: 16px;
    }
    
    .signature-board-container {
        position: relative;
    }
    
    .signature-visibility {
        display: flex;
        align-items: center;
        margin-top: 5px;
        font-size: 12px;
    }
    
    .signature-visibility i {
        margin-right: 5px;
        color: #28a745;
    }
    
    .signature-visibility.hidden i {
        color: #dc3545;
    }
    
    .signature-item.dragging-from-sidebar {
        opacity: 0.8;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .sidebar-actions {
        display: flex;
        justify-content: center;
        margin-top: 5px;
    }
    
    .sidebar-action-btn {
        background: none;
        border: none;
        font-size: 12px;
        color: #007bff;
        cursor: pointer;
        padding: 2px 5px;
    }
    
    .sidebar-action-btn:hover {
        text-decoration: underline;
    }
    
    .my-signature-item.on-board {
        background: #e8f4ff;
        border-color: #b8daff;
    }
    
    .my-signature-item.hidden-item {
        background: #f8d7da;
        border-color: #f5c6cb;
        opacity: 0.7;
    }
    
    /* 签名拖动时的占位符 */
    .signature-placeholder {
        border: 2px dashed #999;
        background-color: rgba(0, 0, 0, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>互动签名墙 - <span class="text-primary">{{ board.title }}</span></h2>
        {% if user.is_authenticated %}
            <a href="{% url 'create_board_signature' board_id=board.pk %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> 在此墙上传签名
            </a>
        {% endif %}
    </div>
    
    <!-- Toast提示容器 -->
    <div class="toast-container"></div>
    
    <div id="board-controls" class="row align-items-center">
        <div class="col-md-6">
            <p class="mb-0">拖拽签名到任意位置，使用控制按钮旋转和调整大小。</p>
            {% if user.is_authenticated %}
            <p class="mb-0 mt-1"><small class="text-muted">点击右侧边栏按钮 <i class="fas fa-chevron-left text-primary"></i> 管理您的签名</small></p>
            {% endif %}
            <button id="show-help" class="btn btn-sm btn-info mt-2">
                <i class="fas fa-question-circle"></i> 查看使用帮助
            </button>
        </div>
        <div class="col-md-6 text-end">
            <button id="save-positions" class="btn btn-success me-2" data-board-id="{{ board.pk }}">
                <i class="fas fa-save"></i> 保存布局
            </button>
            <button id="reset-positions" class="btn btn-outline-secondary">
                <i class="fas fa-undo"></i> 重置布局
            </button>
        </div>
    </div>
    
    <!-- 帮助模态框 -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">互动签名墙使用帮助</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="mb-3">基本操作指南：</h6>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <i class="fas fa-arrows-alt text-warning"></i> <strong>移动签名：</strong> 
                            直接用鼠标拖拽签名卡片到任意位置，或使用右上角的移动按钮
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-sync-alt text-primary"></i> <strong>旋转签名：</strong> 
                            使用右下角的旋转按钮调整签名角度
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-expand-arrows-alt text-success"></i> <strong>调整大小：</strong> 
                            通过左下角的缩放按钮可以更改签名大小
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-save text-warning"></i> <strong>保存布局：</strong> 
                            完成布局后，点击"保存布局"按钮将永久保存位置、角度和大小
                        </li>
                    </ul>
                    {% if user.is_authenticated %}
                    <div class="alert alert-primary mt-3">
                        <i class="fas fa-info-circle"></i> <strong>侧边栏使用：</strong> 
                        <ul class="mb-0 mt-1">
                            <li>点击页面右侧的 <i class="fas fa-chevron-left"></i> 按钮打开侧边栏</li>
                            <li>从侧边栏拖动您的签名到墙上显示</li>
                            <li>将墙上的签名拖出签名墙可将其隐藏</li>
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb"></i> <strong>提示：</strong> 
                        签名墙布局会为所有访问者展示，让您的创意被更多人看到！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">了解了</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 右键菜单 -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="bring-forward">
            <i class="fas fa-arrow-up"></i> 上移一层
        </div>
        <div class="context-menu-item" id="send-backward">
            <i class="fas fa-arrow-down"></i> 下移一层
        </div>
        <div class="context-menu-item" id="bring-to-front">
            <i class="fas fa-level-up-alt"></i> 置于顶层
        </div>
        <div class="context-menu-item" id="send-to-back">
            <i class="fas fa-level-down-alt"></i> 置于底层
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="hide-signature">
            <i class="fas fa-eye-slash"></i> 从墙上隐藏
        </div>
    </div>
    
    <div class="signature-board-container">
        <!-- 侧边栏：用户签名列表 -->
        {% if user.is_authenticated %}
        <div id="signatures-sidebar" class="sidebar-closed">
            <div id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="sidebar-header">
                <h5>我的签名</h5>
                <a href="{% url 'create_signature' %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i>
                </a>
            </div>
            <div id="my-signatures-container">
                <!-- 这里将通过AJAX加载用户的签名 -->
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">加载我的签名...</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div id="signature-board" class="mb-4">
        {% for placement in placements %}
            <div class="signature-item" 
                 id="signature-{{ placement.signature.id }}"
                 data-id="{{ placement.signature.id }}"
                 data-x="{{ placement.position_x }}"
                 data-y="{{ placement.position_y }}"
                 data-rotation="{{ placement.rotation }}"
                 data-scale="{{ placement.scale }}"
                 data-z-index="{{ placement.z_index }}"
                 data-user-id="{{ placement.signature.user.id }}"
                 data-username="{{ placement.signature.user.username }}"
                 {% if user.id == placement.signature.user.id or user.is_staff %}data-can-edit="true"{% endif %}
                 style="transform: translate({{ placement.position_x }}px, {{ placement.position_y }}px) rotate({{ placement.rotation }}deg) scale({{ placement.scale }});
                        z-index: {{ placement.z_index }};">
                <img src="{{ placement.signature.image.url }}" alt="{{ placement.signature.title }}">
                
                <!-- 悬停工具提示 -->
                <div class="signature-tooltip">
                    <strong>{{ placement.signature.title }}</strong><br>
                    作者: {{ placement.signature.user.username }}
                    {% if placement.signature.description %}
                    <br>{{ placement.signature.description|truncatechars:50 }}
                    {% endif %}
                </div>
                
                {% if user.is_authenticated %}
                    {% if user.id == placement.signature.user.id or user.is_staff %}
                    <!-- 移动按钮 - 右上角 -->
                    <div class="control-btn move-handle" title="移动">
                        <i class="fas fa-arrows-alt"></i>
                    </div>
                    
                    <!-- 缩放按钮 - 左下角 -->
                    <div class="control-btn resize-handle" title="调整大小">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </div>
                    
                    <!-- 旋转按钮 - 右下角 -->
                    <div class="control-btn rotate-handle" title="旋转">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.17/dist/interact.min.js"></script>
<script>
    // 当前选中的签名项
    let currentSignature = null;
    const boardId = "{{ board.pk }}"; // 获取当前签名墙ID
    
    document.addEventListener('DOMContentLoaded', function() {
        // 侧边栏相关初始化
        initSidebar();
        
        const signatureItems = document.querySelectorAll('.signature-item');
        
        signatureItems.forEach(item => {
            const x = parseFloat(item.dataset.x) || 0;
            const y = parseFloat(item.dataset.y) || 0;
            const rotation = parseInt(item.dataset.rotation) || 0;
            const scale = parseFloat(item.dataset.scale) || 1.0;
            const zIndex = parseInt(item.dataset.zIndex) || 1;
            
            // 立即设置层级，并将元素置于动画起始位置（透明，稍上方）
            item.style.zIndex = zIndex;
            item.style.opacity = '0';
            item.style.transform = `translate(${x}px, ${y - 20}px) rotate(${rotation}deg) scale(${scale * 0.95})`;

            // 随机延迟后开始入场动画
            setTimeout(() => {
                item.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-out';
                item.style.opacity = '1';
                item.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg) scale(${scale})`;

                // 动画结束后移除过渡效果，避免影响后续的拖拽等操作
                setTimeout(() => {
                    item.style.removeProperty('transition');
                }, 400);
            }, 200 + Math.random() * 300);
        });

        // 拖拽功能 - 现在只对移动按钮生效
        interact('.move-handle').draggable({
            inertia: false,
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: '#signature-board',
                    endOnly: true
                })
            ],
            autoScroll: true,
            
            // 存储鼠标在元素内部的点击位置偏移
            onstart: function(event) {
                // 获取父元素（签名卡片）
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                // 检查权限
                const canEdit = target.getAttribute('data-can-edit') === 'true';
                if (!canEdit) {
                    showToast('您没有编辑这个签名的权限');
                    return;
                }
                
                const rect = target.getBoundingClientRect();
                
                // 添加"正在拖拽"状态类
                target.classList.add('dragging');
                
                // 计算鼠标点击位置相对于元素左上角的偏移
                const offsetX = event.clientX - rect.left;
                const offsetY = event.clientY - rect.top;
                
                // 保存偏移值到元素的data属性
                target.setAttribute('data-offset-x', offsetX);
                target.setAttribute('data-offset-y', offsetY);
                
                // 显示用户正在拖拽的视觉反馈
                target.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                target.style.zIndex = '1000';
                
                // 移动按钮高亮
                event.target.style.opacity = '1';
                event.target.style.transform = 'scale(1.2)';
            },
            
            onmove: function(event) {
                // 获取签名卡片
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                dragMoveListener(event, target);
            },
            
            onend: function (event) {
                // 获取签名卡片
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                const x = parseFloat(target.getAttribute('data-x')) || 0;
                const y = parseFloat(target.getAttribute('data-y')) || 0;
                
                // 移除"正在拖拽"状态类
                target.classList.remove('dragging');
                
                // 恢复正常阴影和z-index
                target.style.boxShadow = '2px 2px 5px rgba(0, 0, 0, 0.3)';
                target.style.zIndex = target.getAttribute('data-z-index') || '1';
                
                // 保存单个签名位置到服务器
                saveSignaturePosition(target);
                
                // 将最终位置存储到元素的data属性中
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
                
                // 拖拽结束后，通过小动画显示位置已固定
                target.style.transition = 'transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                // 先"弹"一下，然后回到原位
                const currentTransform = target.style.transform;
                target.style.transform = currentTransform + ' scale(1.05)';
                
                setTimeout(() => {
                    target.style.transform = currentTransform;
                    setTimeout(() => {
                        target.style.transition = '';
                    }, 150);
                }, 50);
                
                // 恢复移动按钮样式
                event.target.style.opacity = '';
                event.target.style.transform = '';
                
                // 显示提示信息
                showToast('签名已固定在新位置');
            }
        })
        
        // 允许整个签名区域的双击移动
        interact('.signature-item')
            .on('doubletap', function(event) {
                // 只有在双击签名本身而不是控制按钮时才启用拖动模式
                if (!event.target.closest('.control-btn')) {
                    const target = event.currentTarget;
                    
                    // 检查权限
                    const canEdit = target.getAttribute('data-can-edit') === 'true';
                    if (!canEdit) {
                        showToast('您没有编辑这个签名的权限');
                        return;
                    }
                    
                    target.classList.add('temp-draggable');
                    showToast('签名临时可拖动模式已启用');
                    
                    // 临时启用拖动模式
                    interact(target).draggable({
                        onmove: function(moveEvent) {
                            dragMoveListener(moveEvent, target);
                        },
                        onend: function() {
                            target.classList.remove('temp-draggable');
                            interact(target).draggable(false);
                            showToast('签名已固定');
                        }
                    });
                }
            })
        // 缩放按钮功能
        interact('.resize-handle').draggable({
            onstart: function(event) {
                // 获取签名卡片
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                // 检查权限
                const canEdit = target.getAttribute('data-can-edit') === 'true';
                if (!canEdit) {
                    showToast('您没有编辑这个签名的权限');
                    return;
                }
                
                // 高亮缩放按钮
                event.target.style.opacity = '1';
                event.target.style.transform = 'scale(1.2)';
                event.target.style.boxShadow = '0 0 8px rgba(40, 167, 69, 0.8)';
                
                // 添加缩放时的视觉效果
                target.classList.add('resizing');
                
                // 记录初始尺寸和缩放比例
                const rect = target.getBoundingClientRect();
                target.setAttribute('data-initial-width', rect.width);
                target.setAttribute('data-initial-height', rect.height);
                target.setAttribute('data-start-scale', target.getAttribute('data-scale') || 1.0);
                
                // 清除上一次的起始位置记录
                target.removeAttribute('data-start-x');
                target.removeAttribute('data-start-y');
                
                // 显示缩放开始提示
                showToast('拖动调整大小：向右上拖动放大，向左下拖动缩小', 1500);
            },
            
            onmove: function(event) {
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                // 获取初始值和当前鼠标位置
                const initialWidth = parseFloat(target.getAttribute('data-initial-width'));
                const initialHeight = parseFloat(target.getAttribute('data-initial-height'));
                const startScale = parseFloat(target.getAttribute('data-start-scale')) || 1.0;
                
                // 获取起始点和当前鼠标位置
                const startX = parseFloat(target.getAttribute('data-start-x') || 0);
                const startY = parseFloat(target.getAttribute('data-start-y') || 0);
                
                if (!target.hasAttribute('data-start-x')) {
                    // 首次移动，记录起始位置
                    target.setAttribute('data-start-x', event.clientX);
                    target.setAttribute('data-start-y', event.clientY);
                    return; // 第一次移动仅记录位置
                }
                
                // 计算鼠标移动的距离（向左下是缩小，向右上是放大）
                const dx = event.clientX - startX;
                const dy = event.clientY - startY;
                
                // 鼠标移动的总距离，左下为负，右上为正
                const distanceMoved = -dx - dy; // 反转方向，使向右上为放大
                
                // 计算缩放因子：每移动100像素变化50%大小
                const sensitivityFactor = 0.5; // 灵敏度调节因子
                const scalingAmount = distanceMoved * sensitivityFactor / 100;
                
                // 应用缩放倍数
                let newScale = startScale * (1 + scalingAmount);
                
                // 限制最小和最大缩放比例
                newScale = Math.max(0.5, Math.min(newScale, 3.0));
                
                // 保持当前的位置和旋转角度
                const x = parseFloat(target.getAttribute('data-x')) || 0;
                const y = parseFloat(target.getAttribute('data-y')) || 0;
                const transform = target.style.transform;
                const rotateMatch = transform.match(/rotate\(([^)]+)\)/);
                const rotation = rotateMatch ? rotateMatch[0] : 'rotate(0deg)';
                
                // 更新元素的样式
                target.style.transform = `translate(${x}px, ${y}px) ${rotation} scale(${newScale})`;
                target.setAttribute('data-scale', newScale);
                
                // 显示当前缩放比例的提示
                const scalePercentage = Math.round(newScale * 100);
                showToast(`缩放比例: ${scalePercentage}%`, 500);
            },
            
            onend: function(event) {
                const target = event.target.closest('.signature-item');
                if (!target) return;
                
                // 恢复缩放按钮样式
                event.target.style.opacity = '';
                event.target.style.transform = '';
                event.target.style.boxShadow = '';
                
                // 移除缩放时的视觉效果
                target.classList.remove('resizing');
                
                // 缩放完成后的动画效果
                target.style.transition = 'box-shadow 0.3s ease';
                target.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.7)';
                
                setTimeout(() => {
                    target.style.boxShadow = '2px 2px 5px rgba(0, 0, 0, 0.3)';
                    setTimeout(() => {
                        target.style.transition = '';
                    }, 300);
                }, 300);
                
                // 显示调整完成的提示
                const scale = parseFloat(target.getAttribute('data-scale')) || 1.0;
                const scalePercentage = Math.round(scale * 100);
                showToast(`签名大小已调整为 ${scalePercentage}%`);
                
                // 清除所有临时数据属性
                target.removeAttribute('data-initial-width');
                target.removeAttribute('data-initial-height');
                target.removeAttribute('data-start-scale');
                target.removeAttribute('data-start-x');
                target.removeAttribute('data-start-y');
                
                // 保存位置到服务器
                saveSignaturePosition(target);
            }
        });
        
        // 旋转功能
        interact('.rotate-handle')
            .draggable({
                onstart: function(event) {
                    const signatureItem = event.target.closest('.signature-item');
                    if (!signatureItem) return;
                    
                    // 检查权限
                    const canEdit = signatureItem.getAttribute('data-can-edit') === 'true';
                    if (!canEdit) {
                        showToast('您没有编辑这个签名的权限');
                        return;
                    }
                    
                    // 高亮旋转按钮
                    event.target.style.opacity = '1';
                    event.target.style.transform = 'scale(1.2)';
                    event.target.style.boxShadow = '0 0 8px rgba(0, 123, 255, 0.8)';
                    
                    signatureItem.classList.add('rotating');
                },
                onmove: function(event) {
                    // 获取旋转把手的父元素（签名项）
                    const signatureItem = event.target.closest('.signature-item');
                    if (signatureItem) {
                        rotateElement(event, signatureItem);
                    }
                },
                onend: function(event) {
                    // 恢复旋转按钮样式
                    event.target.style.opacity = '';
                    event.target.style.transform = '';
                    event.target.style.boxShadow = '';
                    
                    const signatureItem = event.target.closest('.signature-item');
                    if (signatureItem) {
                        signatureItem.classList.remove('rotating');
                        
                        // 获取旋转角度并显示提示
                        const transform = signatureItem.style.transform;
                        const rotateMatch = transform.match(/rotate\(([^)]+)\)/);
                        const degrees = rotateMatch ? parseInt(rotateMatch[1]) : 0;
                        showToast(`签名已旋转至 ${degrees}°`);
                        
                        // 保存位置到服务器
                        saveSignaturePosition(signatureItem);
                    }
                }
            });
        
        // 保存布局按钮
        document.getElementById('save-positions').addEventListener('click', savePositions);
        
        // 重置布局按钮
        document.getElementById('reset-positions').addEventListener('click', resetPositions);
        
        // 帮助按钮
        document.getElementById('show-help').addEventListener('click', function() {
            const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
            helpModal.show();
        });
        
        // ===== 右键菜单功能 =====
        const contextMenu = document.getElementById('context-menu');
        const signatureBoard = document.getElementById('signature-board');
        
        // 禁用签名墙的默认右键菜单
        signatureBoard.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // 为所有签名项添加右键菜单事件
        document.querySelectorAll('.signature-item').forEach(item => {
            item.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                // 获取当前签名的用户ID和编辑权限
                const canEdit = item.getAttribute('data-can-edit') === 'true';
                
                // 如果没有编辑权限，不显示菜单
                if (!canEdit) {
                    showToast('您没有编辑这个签名的权限');
                    return;
                }
                
                // 设置当前选中的签名
                currentSignature = item;
                
                // 显示右键菜单
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                
                // 阻止冒泡
                e.stopPropagation();
            });
        });
        
        // 点击页面其他地方关闭右键菜单
        document.addEventListener('click', function() {
            contextMenu.style.display = 'none';
        });
        
        // 右键菜单项功能
        document.getElementById('hide-signature').addEventListener('click', function() {
            if (currentSignature) {
                const signatureId = currentSignature.dataset.id;
                // 调用新的切换可见性函数
                toggleVisibility(signatureId, false);
            }
        });
        
        // 层级调整的动画效果
        function animateLayerChange(signature, zIndexChange) {
            // 先添加一个缩放效果
            signature.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease';
            
            // 根据是上移还是下移设置不同的动画效果
            if (zIndexChange > 0) { // 上移
                signature.style.boxShadow = '0 8px 15px rgba(0, 0, 0, 0.4)';
                signature.style.transform += ' scale(1.05)';
            } else { // 下移
                signature.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                signature.style.transform += ' scale(0.95)';
            }
            
            // 动画结束后恢复原样
            setTimeout(() => {
                // 获取当前的transform值，但不包括临时的缩放
                const transform = signature.style.transform.replace(' scale(1.05)', '').replace(' scale(0.95)', '');
                signature.style.transform = transform;
                signature.style.boxShadow = '2px 2px 5px rgba(0, 0, 0, 0.3)';
                
                setTimeout(() => {
                    signature.style.transition = '';
                }, 300);
            }, 300);
        }
        
        // 上移一层
        document.getElementById('bring-forward').addEventListener('click', function() {
            if (currentSignature) {
                const currentZIndex = parseInt(currentSignature.style.zIndex) || 1;
                const newZIndex = currentZIndex + 1;
                currentSignature.style.zIndex = newZIndex;
                currentSignature.setAttribute('data-z-index', newZIndex);
                
                // 显示层级变化的动画效果
                animateLayerChange(currentSignature, 1);
                
                showToast(`签名已上移一层 (层级: ${newZIndex})`);
            }
        });
        
        // 下移一层
        document.getElementById('send-backward').addEventListener('click', function() {
            if (currentSignature) {
                const currentZIndex = parseInt(currentSignature.style.zIndex) || 1;
                if (currentZIndex > 1) {
                    const newZIndex = currentZIndex - 1;
                    currentSignature.style.zIndex = newZIndex;
                    currentSignature.setAttribute('data-z-index', newZIndex);
                    
                    // 显示层级变化的动画效果
                    animateLayerChange(currentSignature, -1);
                    
                    showToast(`签名已下移一层 (层级: ${newZIndex})`);
                } else {
                    showToast('签名已经在最底层 (层级: 1)');
                }
            }
        });
        
        // 置于顶层
        document.getElementById('bring-to-front').addEventListener('click', function() {
            if (currentSignature) {
                // 获取所有签名中的最高层级
                let maxZIndex = 1;
                document.querySelectorAll('.signature-item').forEach(item => {
                    const zIndex = parseInt(item.style.zIndex) || 1;
                    maxZIndex = Math.max(maxZIndex, zIndex);
                });
                
                const newZIndex = maxZIndex + 1;
                currentSignature.style.zIndex = newZIndex;
                currentSignature.setAttribute('data-z-index', newZIndex);
                
                // 显示层级变化的动画效果
                animateLayerChange(currentSignature, 10);
                
                showToast(`签名已置于顶层 (层级: ${newZIndex})`);
            }
        });
        
        // 置于底层
        document.getElementById('send-to-back').addEventListener('click', function() {
            if (currentSignature) {
                currentSignature.style.zIndex = '1';
                currentSignature.setAttribute('data-z-index', 1);
                
                // 显示层级变化的动画效果
                animateLayerChange(currentSignature, -10);
                
                showToast('签名已置于底层 (层级: 1)');
            }
        });
        
        // 从墙上隐藏
        document.getElementById('hide-signature').addEventListener('click', function() {
            if (currentSignature) {
                if (confirm('确定要从签名墙上隐藏此签名吗？这将在下次保存布局时生效。')) {
                    currentSignature.classList.add('hidden');
                    
                    // 将此签名标记为非公开
                    const signatureId = currentSignature.getAttribute('data-id');
                    
                    // 发送请求更新签名公开状态
                    fetch(`/signatures/${signatureId}/toggle-visibility/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ is_public: false })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('签名已从墙上隐藏');
                        } else {
                            showToast('操作失败: ' + data.error);
                            currentSignature.classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('错误:', error);
                        showToast('网络错误，请重试');
                        currentSignature.classList.remove('hidden');
                    });
                }
            }
        });
    });
    
    function dragMoveListener(event, targetElement) {
        // 如果提供了特定目标，使用它；否则使用事件目标
        const target = targetElement || event.target;
        
        // 保持当前的旋转角度和缩放比例
        const transform = target.style.transform;
        const rotateMatch = transform.match(/rotate\(([^)]+)\)/);
        const scaleMatch = transform.match(/scale\(([^)]+)\)/);
        
        const rotation = rotateMatch ? rotateMatch[0] : 'rotate(0deg)';
        const scale = scaleMatch ? scaleMatch[0] : 'scale(1)';
        
        // 获取签名板的位置
        const board = document.getElementById('signature-board');
        const boardRect = board.getBoundingClientRect();
        
        // 获取鼠标在元素内的点击偏移
        const offsetX = parseFloat(target.getAttribute('data-offset-x')) || 0;
        const offsetY = parseFloat(target.getAttribute('data-offset-y')) || 0;
        
        // 计算新位置 - 基于鼠标移动距离
        const dx = event.dx;
        const dy = event.dy;
        
        // 获取当前位置
        let x = parseFloat(target.getAttribute('data-x')) || 0;
        let y = parseFloat(target.getAttribute('data-y')) || 0;
        
        // 更新位置
        x += dx;
        y += dy;
        
        // 获取边界约束 - 确保签名完全在签名板内
        const margin = 5; // 边界安全边距
        const finalX = Math.max(margin, Math.min(x, boardRect.width - target.offsetWidth - margin));
        const finalY = Math.max(margin, Math.min(y, boardRect.height - target.offsetHeight - margin));
        
        // 更新元素的样式和位置数据
        target.style.transform = `translate(${finalX}px, ${finalY}px) ${rotation} ${scale}`;
        target.setAttribute('data-x', finalX);
        target.setAttribute('data-y', finalY);
        
        // 更新控制按钮的位置，确保它们跟随签名移动
        // (这部分由CSS自动处理，因为控制按钮是签名的子元素)
        
        // 添加拖动过程中的视觉反馈
        target.classList.add('dragging');
    }
    
    function rotateElement(event, target) {
        // 如果未提供target，则使用event.target
        if (!target) {
            target = event.target;
        }
        
        const rect = target.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const angle = Math.atan2(event.clientY - centerY, event.clientX - centerX);
        const degrees = angle * (180 / Math.PI);
        
        // 从数据属性获取当前的缩放比例，更可靠
        let scale = parseFloat(target.getAttribute('data-scale')) || 1.0;
        
        // 保持当前的位移
        const x = parseFloat(target.getAttribute('data-x')) || 0;
        const y = parseFloat(target.getAttribute('data-y')) || 0;
        
        // 更新旋转角度
        target.style.transform = `translate(${x}px, ${y}px) rotate(${degrees}deg) scale(${scale})`;
        target.setAttribute('data-rotation', degrees);
        
        // 添加旋转时的视觉反馈
        target.classList.add('rotating');
        setTimeout(() => {
            target.classList.remove('rotating');
        }, 100);
    }
    
    // 旧的resizeListener函数已被新的拖动缩放逻辑替代
    
    // 保存布局函数
    function savePositions() {
        const saveButton = document.getElementById('save-positions');
        const boardId = saveButton.dataset.boardId;
        const url = `{% url 'save_board_positions' board_id=999 %}`.replace('999', boardId);

        if (!boardId) {
            showToast('错误：无法确定当前签名墙ID', 3000, 'error');
            return;
        }

        const positions = [];
        document.querySelectorAll('#signature-board .signature-item').forEach(item => {
            positions.push({
                id: item.dataset.id,
                position_x: parseFloat(item.dataset.x) || 0,
                position_y: parseFloat(item.dataset.y) || 0,
                rotation: parseInt(item.dataset.rotation) || 0,
                scale: parseFloat(item.dataset.scale) || 1.0,
                z_index: parseInt(item.dataset.zIndex) || 1
            });
        });

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ positions: positions })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('布局已成功保存！', 2000, 'success');
                document.querySelectorAll('.signature-item').forEach(item => {
                    item.classList.add('save-success');
                    setTimeout(() => item.classList.remove('save-success'), 1000);
                });
            } else {
                showToast(`保存失败: ${data.error}`, 3000, 'error');
            }
        })
        .catch(error => {
            showToast(`保存时发生网络错误: ${error}`, 3000, 'error');
        });
    }

    function resetPositions() {
        if (confirm('确定要重置所有签名的位置吗？这将恢复到上次保存的位置')) {
            // 添加重置按钮加载状态
            const resetButton = document.getElementById('reset-positions');
            const originalText = resetButton.innerHTML;
            resetButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重置中...';
            resetButton.disabled = true;
            
            // 获取所有签名元素
            const signatureItems = document.querySelectorAll('.signature-item');
            
            // 添加重置动画
            signatureItems.forEach(item => {
                item.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
                item.classList.add('resetting');
            });
            
            // 延迟一点以显示动画
            setTimeout(() => {
                // 重新加载页面获取服务器端保存的位置
                location.reload();
            }, 800);
        }
    }
    
    // 初始化侧边栏
    function initSidebar() {
        const sidebar = document.getElementById('signatures-sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle');

        if (!sidebar || !toggleBtn) return;

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-closed');
            const icon = toggleBtn.querySelector('i');
            icon.classList.toggle('fa-chevron-left');
            icon.classList.toggle('fa-chevron-right');
        });

        // 加载用户签名
        loadMySignatures();
    }

    // 从服务器加载我的签名
    function loadMySignatures() {
        const container = document.getElementById('my-signatures-container');
        if (!container) return;

        // AJAX请求需要带上board_id
        fetch(`{% url 'api_my_signatures' %}?board_id=${boardId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.innerHTML = ''; // 清空加载提示
                    if (data.signatures.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center small">您还没有创建任何签名。</p>';
                    } else {
                        data.signatures.forEach(sig => {
                            const sigElement = createSidebarSignatureElement(sig);
                            container.appendChild(sigElement);
                        });
                    }
                } else {
                    container.innerHTML = `<p class="text-danger text-center small">加载失败: ${data.error}</p>`;
                }
            })
            .catch(error => {
                container.innerHTML = '<p class="text-danger text-center small">加载时发生网络错误。</p>';
            });
    }

    // 创建侧边栏中的单个签名元素
    function createSidebarSignatureElement(signature) {
        const div = document.createElement('div');
        div.className = 'my-signature-item';
        div.dataset.id = signature.id;
        div.draggable = true;

        // 根据签名在当前墙上的状态添加不同样式
        if (signature.on_board) {
            div.classList.add(signature.is_public ? 'on-board' : 'hidden-item');
        }

        let visibilityIcon = signature.is_public ? 'fa-eye' : 'fa-eye-slash';
        let visibilityText = signature.is_public ? '在墙上可见' : '在墙上隐藏';
        let actionText = signature.on_board ? (signature.is_public ? '隐藏' : '显示') : '添加到墙上';

        div.innerHTML = `
            <img src="${signature.image_url}" alt="${signature.title}">
            <p class="my-signature-title">${signature.title}</p>
            <div class="signature-visibility ${!signature.is_public ? 'hidden' : ''}">
                <i class="fas ${visibilityIcon}"></i>
                <span>${visibilityText}</span>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-action-btn" data-action="toggle">${actionText}</button>
            </div>
        `;

        // 添加或移除签名的事件监听
        div.querySelector('[data-action="toggle"]').addEventListener('click', (e) => {
            e.stopPropagation();
            // 如果签名已在墙上，则切换可见性；否则，添加到墙上
            const newVisibility = !signature.is_public;
            toggleVisibility(signature.id, signature.on_board ? newVisibility : true);
        });

        return div;
    }

    // 切换签名在当前墙上的可见性（或添加到墙上）
    function toggleVisibility(signatureId, isVisible) {
        const url = `{% url 'toggle_signature_visibility' pk=999 %}`.replace('999', signatureId);
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                board_id: boardId, 
                is_public: isVisible 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message || '操作成功', 2000, 'success');
                // 重新加载侧边栏和签名墙状态
                loadMySignatures();
                // 刷新页面以显示或隐藏签名
                location.reload(); 
            } else {
                showToast(`操作失败: ${data.error}`, 3000, 'error');
            }
        })
        .catch(error => {
            showToast(`发生网络错误: ${error}`, 3000, 'error');
        });
    }

    // Toast消息提示函数
    function showToast(message, duration = 2000) {
        const toastContainer = document.querySelector('.toast-container');
        
        // 创建toast元素
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        
        // 添加到容器
        toastContainer.appendChild(toast);
        
        // 显示动画
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        }, 10);
        
        // 自动隐藏
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            
            // 动画完成后移除元素
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, duration);
    }
    
    // 保存单个签名位置到服务器
    function saveSignaturePosition(signature) {
        const id = signature.getAttribute('data-id');
        const x = parseFloat(signature.getAttribute('data-x')) || 0;
        const y = parseFloat(signature.getAttribute('data-y')) || 0;
        const rotation = parseFloat(signature.getAttribute('data-rotation')) || 0;
        const scale = parseFloat(signature.getAttribute('data-scale')) || 1.0;
        const zIndex = parseInt(signature.style.zIndex) || parseInt(signature.getAttribute('data-z-index')) || 1;
        
        const position = {
            id: id,
            position_x: x,
            position_y: y,
            rotation: rotation,
            scale: scale,
            z_index: zIndex
        };
        
        // 发送AJAX请求保存位置
        const url = `{% url 'save_board_positions' board_id=999 %}`.replace('999', boardId);
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ positions: [position] })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('保存签名位置失败:', data.error);
                showToast('保存位置失败: ' + data.error, 3000, 'error');
            } else {
                // 可选：显示成功动画
                signature.classList.add('save-success');
                setTimeout(() => signature.classList.remove('save-success'), 1000);
            }
        })
        .catch(error => {
            console.error('保存签名位置请求失败:', error);
            showToast('网络错误：无法保存位置', 3000, 'error');
        });
    }
</script>
{% endblock %}
