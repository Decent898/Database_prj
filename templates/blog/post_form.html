{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}创建文章 - 博客{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<style>
    /* 数学公式样式 */
    .math {
        overflow-x: auto;
        max-width: 100%;
        padding: 5px 0;
    }
    .editor-preview .math, .editor-preview-side .math {
        background-color: #f9f9f9;
        border-radius: 3px;
        padding: 2px 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">{% if form.instance.pk %}编辑文章{% else %}创建新文章{% endif %}</h3>
    </div>
    <div class="card-body">
        <form method="POST">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-8">
                    {{ form.title|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.slug|as_crispy_field }}
                </div>
            </div>
            
            {{ form.content|as_crispy_field }}
            
            <div class="row">
                <div class="col-md-6">
                    {{ form.signature|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.is_published|as_crispy_field }}
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">文章标签</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label>现有标签</label>
                        {{ form.tags|as_crispy_field }}
                    </div>
                    <div class="mt-3">
                        <label>添加自定义标签</label>
                        {{ form.new_tags|as_crispy_field }}
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">保存文章</button>
                {% if form.instance.pk %}
                    <a href="{% url 'post_detail' form.instance.pk form.instance.slug %}" class="btn btn-outline-secondary">取消1</a>
                {% else %}
                    <a href="{% url 'my_posts' %}" class="btn btn-outline-secondary">取消2</a>
                {% endif %}
            </div>
        </form>
    </div>
    <div class="card-footer">
        <div class="alert alert-info mb-0">
            <h5 class="alert-heading">编辑提示:</h5>
            <ul>
                <li>标题应简洁明了，概括文章主题</li>
                <li>Slug用于URL，只能包含小写字母、数字和连字符</li>
                <li>文章内容支持Markdown格式</li>
                <li>选择一个签名将文章与您的签名关联</li>
                <li>勾选"发布"选项使文章公开可见</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<!-- KaTeX JS -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取表单和内容字段
        const form = document.querySelector('form');
        const contentField = document.getElementById('id_content');
        
        // 移除textarea的required属性，避免浏览器验证
        contentField.removeAttribute('required');
        
        // 帮助函数：在预览中渲染数学公式
        function renderMathInPreview(preview) {
            if (!preview) return;
            renderMathInElement(preview, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},  // 行间公式
                    {left: '$', right: '$', display: false},   // 行内公式
                    {left: '\\(', right: '\\)', display: false}, // 行内公式的另一种写法
                    {left: '\\[', right: '\\]', display: true}   // 行间公式的另一种写法
                ],
                throwOnError: false,
                trust: true
            });
        }
        
        // 初始化EasyMDE
        const easyMDE = new EasyMDE({
            element: contentField,
            spellChecker: false,
            autosave: {
                enabled: true,
                uniqueId: "blog_post_{{ form.instance.pk|default:'new' }}",
                delay: 1000,
            },
            toolbar: [
                "bold", "italic", "heading", "|", 
                "quote", "unordered-list", "ordered-list", "|", 
                "link", "image", "table", "code", "|", 
                {
                    name: "custom-math-inline",
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const text = cm.getSelection() || "公式";
                        cm.replaceSelection("$" + text + "$");
                    },
                    className: "fa fa-superscript",
                    title: "插入行内公式 ($公式$)",
                },
                {
                    name: "custom-math-block",
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const text = cm.getSelection() || "公式";
                        cm.replaceSelection("\n$$\n" + text + "\n$$\n");
                    },
                    className: "fa fa-calculator",
                    title: "插入公式块 ($$公式$$)",
                },
                "|",
                "preview", "side-by-side", "fullscreen", "|", 
                "guide"
            ],
            previewRender: function(plainText, preview) { 
                // 渲染Markdown为HTML
                preview.innerHTML = this.parent.markdown(plainText);
                // 延迟渲染数学公式，确保DOM已经更新
                setTimeout(() => renderMathInPreview(preview), 0);
                return preview.innerHTML;
            },
        });
        
        // 确保EasyMDE内容可以提交
        form.addEventListener('submit', function(e) {
            // 阻止表单默认提交
            e.preventDefault();
            
            try {
                // 将EasyMDE内容同步到原始textarea
                contentField.value = easyMDE.value();
                
                // 检查内容是否为空
                if (!contentField.value.trim()) {
                    alert('文章内容不能为空！');
                    return false;
                }
                
                // 让我们直接使用fetch API提交表单
                const formData = new FormData(this);
                
                // 获取CSRF令牌
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // 使用fetch API提交表单
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    }
                }).then(response => {
                    // 检查是否是JSON响应
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        // 处理JSON响应
                        return response.json().then(data => {
                            if (response.ok) {
                                if (data.redirect_url) {
                                    window.location.href = data.redirect_url;
                                }
                            } else {
                                console.error('表单验证错误:', data.errors);
                                alert('表单验证失败，请检查输入。');
                            }
                        });
                    } else {
                        // 非JSON响应处理
                        if (response.redirected) {
                            // 如果服务器返回重定向，则跟随重定向
                            window.location.href = response.url;
                        } else {
                            // 如果有错误，显示错误信息
                            response.text().then(html => {
                                // 简单地刷新页面，显示服务器返回的错误
                                document.open();
                                document.write(html);
                                document.close();
                            });
                        }
                    }
                }).catch(error => {
                    console.error('表单提交错误:', error);
                    alert('表单提交失败，请重试');
                });
            } catch (error) {
                console.error('处理表单时出错:', error);
                alert('处理表单时出错，请重试');
            }
        });
    });
</script>
{% endblock %}
